/*
 * Copyright (c) 2015, Freescale Semiconductor, Inc.
 * Copyright 2016-2017 NXP
 * All rights reserved.
 *
 * SPDX-License-Identifier: BSD-3-Clause
 */

/* FreeRTOS kernel includes. */
#include "FreeRTOS.h"
#include "task.h"
#include "queue.h"
#include "timers.h"

/* Freescale includes. */
#include "fsl_device_registers.h"
#include "fsl_debug_console.h"
#include "pin_mux.h"
#include "clock_config.h"
#include "board.h"

#include "fsl_lpuart.h"
#include "fsl_lpspi_freertos.h"
#include "fsl_gpio.h"
/*******************************************************************************
 * Definitions
 ******************************************************************************/

/* Task priorities. */
#define spi_PRIORITY (configMAX_PRIORITIES - 1)
#define LPUART_CLK_FREQ   CLOCK_GetIpFreq(kCLOCK_DMA_Lpspi2)

#define EXAMPLE_OLED_OC_GPIO     LSIO__GPIO1
#define EXAMPLE_OLED_OC_GPIO_PIN    23U
#define EXAMPLE_OLED_RESET_GPIO     LSIO__GPIO1
#define EXAMPLE_OLED_RESET_GPIO_PIN    24U

/*******************************************************************************
 * Prototypes
 ******************************************************************************/
static void spi_task(void *pvParameters);
void oled_ins_trans(uint8_t *command, uint8_t sizes);
void oled_column_set(uint8_t colume);
void oled_page_set(uint8_t page);
void oled_write_all_pages(uint8_t *ptr_data);
void oled_init(void);

/*******************************************************************************
 * Code
 ******************************************************************************/
/*!
 * @brief Application entry point.
 */

lpspi_rtos_handle_t handle;

lpspi_master_config_t lpspi_config = {
    .baudRate = 6000000,
    .bitsPerFrame = 1024,       /*!< Bits per frame, minimum 8, maximum 4096.*/
    .cpol = kLPSPI_ClockPolarityActiveLow,
    .cpha = kLPSPI_ClockPhaseSecondEdge,
    .direction = kLPSPI_MsbFirst,
    .pcsToSckDelayInNanoSec = 50,
    .lastSckToPcsDelayInNanoSec = 50,
    .betweenTransferDelayInNanoSec = 50,
    .whichPcs = kLPSPI_Pcs0,
    .pcsActiveHighOrLow = kLPSPI_PcsActiveLow,
    .pinCfg = kLPSPI_SdiInSdoOut,
    .dataOutConfig = kLpspiDataOutRetained,
};

uint8_t send_buffer[128];
uint8_t recv_buffer[128];
lpspi_transfer_t spi_data = {
    .txData = send_buffer,
    .rxData = recv_buffer,
    .dataSize = sizeof(send_buffer),
    .configFlags = kLPSPI_MasterPcs0 | kLPSPI_MasterPcsContinuous | kLPSPI_MasterByteSwap,
};


uint8_t picture_tab[]={
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x20,0x20,0x20,0x20,0xE0,0x20,0x20,0x20,0x20,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xE0,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0xFF,0x00,0x00,0x00,0x3C,0x42,0x81,0x81,0x81,0x42,
0x3C,0x00,0x00,0xFF,0x02,0x01,0x01,0x01,0x00,0x70,0x8A,0x89,0x89,0x89,0x4B,0xFE,
0x00,0x00,0x3C,0x42,0x81,0x81,0x81,0x42,0xFF,0x00,0x00,0x00,0x3C,0x4A,0x89,0x89,
0x89,0x8A,0x4C,0x00,0x00,0x81,0xC3,0x24,0x18,0x18,0x24,0xC3,0x81,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0xF0,0x0C,0x04,0x02,0x02,0x02,0x02,0x04,0x0C,0xF0,
0x00,0x00,0xFE,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xFE,0x02,0x02,0x02,0x02,0x02,
0x04,0x0C,0xF0,0x00,0x00,0x00,0xFE,0x42,0x42,0x42,0x42,0x42,0x42,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0xFE,0x02,0x02,0x02,0x02,0x02,0x04,0x0C,0xF0,0x00,0x00,0x00,
0xF0,0x20,0x10,0x10,0x10,0x00,0xF6,0x00,0x00,0x30,0xC0,0x00,0x00,0x00,0x00,0xC0,
0x30,0x00,0x00,0xC0,0xA0,0x90,0x90,0x90,0xA0,0xC0,0x00,0x00,0xF0,0x20,0x10,0x10,
0x10,0x30,0xE0,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xFE,0x20,0x10,0x10,0x10,
0x20,0xC0,0x00,0x00,0x10,0x60,0x80,0x00,0x00,0x00,0xC0,0x30,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x01,0x06,0x04,0x08,0x08,0x08,0x08,0x04,0x06,0x01,
0x00,0x00,0x0F,0x08,0x08,0x08,0x08,0x08,0x08,0x00,0x0F,0x08,0x08,0x08,0x08,0x08,
0x04,0x06,0x01,0x00,0x00,0x00,0x0F,0x08,0x08,0x08,0x08,0x08,0x08,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x0F,0x08,0x08,0x08,0x08,0x08,0x04,0x06,0x01,0x00,0x00,0x00,
0x0F,0x00,0x00,0x00,0x00,0x00,0x0F,0x00,0x00,0x00,0x00,0x03,0x0C,0x0C,0x03,0x00,
0x00,0x00,0x00,0x03,0x04,0x08,0x08,0x08,0x08,0x04,0x00,0x00,0x0F,0x00,0x00,0x00,
0x00,0x00,0x0F,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x0F,0x04,0x08,0x08,0x08,
0x04,0x03,0x00,0x00,0x00,0x40,0x41,0x26,0x1C,0x03,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xE0,
0x60,0x80,0x00,0x00,0x00,0x00,0x00,0x80,0x60,0xE0,0x00,0x00,0x00,0x00,0x00,0xC0,
0x20,0xE0,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x60,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xE0,0x60,0x80,0x00,
0x00,0x00,0x00,0x00,0x80,0x60,0xE0,0x00,0x00,0x20,0x60,0x80,0x00,0x00,0x80,0x60,
0x20,0x00,0x00,0xC0,0x40,0x20,0x20,0x20,0x20,0x40,0xC0,0x00,0x00,0x20,0x60,0x80,
0x00,0x00,0x80,0x60,0x20,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xFF,
0x00,0x01,0x06,0x18,0x20,0x18,0x06,0x01,0x00,0xFF,0x00,0x00,0x18,0x16,0x11,0x10,
0x10,0xFF,0x10,0x10,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x3C,0x42,0x81,0x81,0x81,
0x42,0x3C,0x00,0x00,0xFF,0x02,0x01,0x01,0x01,0x03,0xFE,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0xFF,0x00,0x00,0x00,0x00,0xC0,0x00,0x00,0x00,0xFF,0x00,0x01,0x06,
0x18,0x20,0x18,0x06,0x01,0x00,0xFF,0x00,0x80,0xC0,0x30,0x19,0x06,0x0F,0x31,0x40,
0x80,0x00,0x00,0x7B,0xCA,0x84,0x84,0x84,0x84,0xCA,0x7B,0x00,0x80,0xC0,0x30,0x19,
0x06,0x0F,0x31,0x40,0x80,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
};


int main(void)
{
    /* Init board hardware. */
    sc_ipc_t ipc;

    ipc = BOARD_InitRpc();
    BOARD_InitPins(ipc);
    BOARD_BootClockRUN();
    BOARD_InitDebugConsole();
    BOARD_InitMemory();

    gpio_pin_config_t oled_oc_config = {kGPIO_DigitalOutput, 0, kGPIO_NoIntmode};
    gpio_pin_config_t oled_reset_config = {kGPIO_DigitalOutput, 0, kGPIO_NoIntmode};

    if (sc_pm_set_resource_power_mode(ipc, SC_R_SPI_2, SC_PM_PW_MODE_ON) != SC_ERR_NONE)
    {
        PRINTF("Error: Failed to power on SPI2\r\n");
    }

    if (sc_pm_set_resource_power_mode(ipc, SC_R_GPIO_1, SC_PM_PW_MODE_ON) != SC_ERR_NONE)
    {
        PRINTF("Error: Failed to power on GPIO\r\n");
    }

    GPIO_PinInit(EXAMPLE_OLED_OC_GPIO, EXAMPLE_OLED_OC_GPIO_PIN, &oled_oc_config);
    GPIO_PinInit(EXAMPLE_OLED_RESET_GPIO, EXAMPLE_OLED_RESET_GPIO_PIN, &oled_reset_config);

    sc_pm_clock_enable(ipc, SC_R_SPI_2, SC_PM_CLK_PER, true, 0);

    if (CLOCK_SetIpFreq(kCLOCK_DMA_Lpspi2, SC_60MHZ) == 0)
    {
        PRINTF("Error: Failed to set SPI2 frequency\r\n");
    }
    
    //NVIC_SetPriority(ADMA_SPI2_INT_IRQn, 5);
    //PRINTF("Basic Init Finised.\r\n");

    // if (kStatus_Success != LPSPI_RTOS_Init(&handle, ADMA__LPSPI2, &lpspi_config, LPUART_CLK_FREQ))
    // {
    //     PRINTF("Failed to init SPI2.\r\n");
    //     vTaskSuspend(NULL);
    // }

    oled_init();
    oled_write_all_pages(picture_tab);

    // if (xTaskCreate(spi_task, "spi_task", configMINIMAL_STACK_SIZE + 100, NULL, spi_PRIORITY, NULL) !=
    //     pdPASS)
    // {
    //     PRINTF("Task creation failed!.\r\n");
    //     while (1)
    //         ;
    // }
    // vTaskStartScheduler();

    PRINTF("Good to see here!.\r\n");
    for (;;)
        ;
}

/*!
 * @brief Task responsible for printing of "Hello world." message.
 */
static void spi_task(void *pvParameters)
{
    // if (kStatus_Success != LPSPI_RTOS_Init(&handle, ADMA__LPSPI2, &lpspi_config, LPUART_CLK_FREQ))
    // {
    //     PRINTF("Failed to init SPI2.\r\n");
    //     vTaskSuspend(NULL);
    // }
    // PRINTF("LPSPI_RTOS_Init finish\r\n");

    if (kStatus_Success != LPSPI_RTOS_TransferBlocking(&handle, &spi_data))
    {
        PRINTF("Failed to send data on SPI2.\r\n");
        vTaskSuspend(NULL);
    }
    PRINTF("LPSPI_RTOS_Transfer finish\r\n");
    
    for (;;)
    {
        PRINTF("Hello world.\r\n");
        vTaskSuspend(NULL);
    }
}


void oled_ins_trans(uint8_t *command, uint8_t sizes)
{
    lpspi_config.bitsPerFrame = 8*sizes;
    if (kStatus_Success != LPSPI_RTOS_Init(&handle, ADMA__LPSPI2, &lpspi_config, LPUART_CLK_FREQ))
    {
        PRINTF("Failed to init SPI2 Single byte.\r\n");
        vTaskSuspend(NULL);
    }

    memcpy(send_buffer, command, sizes);
    spi_data.dataSize = sizes;
    
    GPIO_PinWrite(EXAMPLE_OLED_OC_GPIO, EXAMPLE_OLED_OC_GPIO_PIN, 0U);
    SDK_DelayAtLeastUs(10, SystemCoreClock);

    if (kStatus_Success != LPSPI_RTOS_TransferBlocking(&handle, &spi_data))
    {
        PRINTF("Command Transmission fails.\r\n");
        vTaskSuspend(NULL);
    }

    GPIO_PinWrite(EXAMPLE_OLED_OC_GPIO, EXAMPLE_OLED_OC_GPIO_PIN, 1U);
    SDK_DelayAtLeastUs(10, SystemCoreClock);

}



void oled_column_set(uint8_t colume)
{
    uint8_t column_cmds[2];
    column_cmds[0] = 0x10|(colume>>4);
    column_cmds[1] = 0x00|(colume&0x0f);
    
    oled_ins_trans(column_cmds, 2);
    
}

void oled_page_set(uint8_t page)
{
    uint8_t page_cmds;
    page_cmds = 0xb0+page;
    oled_ins_trans(&page_cmds, 1);
}


void oled_write_all_pages(uint8_t *ptr_data)
{
    uint8_t page;
    for(page=0;page<(64/8);page++)        //page lo
    {
        oled_page_set(page);
        oled_column_set(2);
        lpspi_config.bitsPerFrame = 1024U;
        if (kStatus_Success != LPSPI_RTOS_Init(&handle, ADMA__LPSPI2, &lpspi_config, LPUART_CLK_FREQ))
        {
            PRINTF("Failed to init SPI2 for all pages writing.\r\n");
            vTaskSuspend(NULL);
        }
        memcpy(send_buffer, (ptr_data + (page*128)), 128);
        //spi_data.txData = ptr_data + (page*128);
        spi_data.dataSize = 128U;       // max 128bytes per page
        if (kStatus_Success != LPSPI_RTOS_TransferBlocking(&handle, &spi_data))
        {
            PRINTF("All Pages Data Transmission fails.\r\n");
            vTaskSuspend(NULL);
        }

    }


}


void oled_init(void)
{
    uint8_t config_cmds[26];

    GPIO_PinWrite(EXAMPLE_OLED_RESET_GPIO, EXAMPLE_OLED_RESET_GPIO_PIN, 0U);
    SDK_DelayAtLeastUs(100, SystemCoreClock);
    GPIO_PinWrite(EXAMPLE_OLED_RESET_GPIO, EXAMPLE_OLED_RESET_GPIO_PIN, 1U);
    SDK_DelayAtLeastUs(100, SystemCoreClock);

    config_cmds[0] = 0xAE;//--turn off oled panel
    config_cmds[1] = 0x02;//--set low column address
    config_cmds[2] = 0x10;//--set high column address
    config_cmds[3] = 0x40;//--set start line address
    config_cmds[4] = 0xB0;//--set page addres
    config_cmds[5] = 0xA1;//--set segment re-map 127 to 0   a0:0 to seg127
    config_cmds[6] = 0xA4;//--set normal display
    config_cmds[7] = 0xA6;//--set indication display
    config_cmds[8] = 0xC8;//--set com(N-1)to com0  c0:com0 to com(N-1)
    config_cmds[9] = 0xA8;//--set multiples ratio(1to64)
    config_cmds[10] = 0x3F;//--1/64 duty
    config_cmds[11] = 0xD5;//--set display clock divide ratio/oscillator frequency
    config_cmds[12] = 0x80;//--set divide ratio
    config_cmds[13] = 0xD3;//--set display offset
    config_cmds[14] = 0x00;//--not offset
    config_cmds[15] = 0xAD;//--DC-DC ON/OFF Mode Set
    config_cmds[16] = 0x8B;//--8A:DC-DC is disable,8B:DC-DC will be turned on when display on.(POR)
    config_cmds[17] = 0x81;//--set contrast control register
    config_cmds[18] = 0xFF;
    config_cmds[19] = 0xDA;//--set com pins hardware configuration
    config_cmds[20] = 0x12;
    config_cmds[21] = 0xDB;//--set vcomh
    config_cmds[22] = 0x40;
    config_cmds[23] = 0xD9;//--set charge period
    config_cmds[24] = 0xF1;
    config_cmds[25] = 0xAF;//--turn on oled panel
    
    oled_ins_trans(config_cmds, 26);

    // oled_ins_trans(0xAE);//--turn off oled panel
    // oled_ins_trans(0x02);//--set low column address
    // oled_ins_trans(0x10);//--set high column address
    // oled_ins_trans(0x40);//--set start line address
    // oled_ins_trans(0xB0);//--set page addres
    // oled_ins_trans(0xA1);//--set segment re-map 127 to 0   a0:0 to seg127
    // oled_ins_trans(0xA4);//--set normal display
    // oled_ins_trans(0xA6);//--set indication display
    // oled_ins_trans(0xC8);//--set com(N-1)to com0  c0:com0 to com(N-1)
    // oled_ins_trans(0xA8);//--set multiples ratio(1to64)
    // oled_ins_trans(0x3F);//--1/64 duty

    // oled_ins_trans(0xD5);//--set display clock divide ratio/oscillator frequency
    // oled_ins_trans(0x80);//--set divide ratio

    // oled_ins_trans(0xD3);//--set display offset
    // oled_ins_trans(0x00);//--not offset

    // oled_ins_trans(0xAD);//--DC-DC ON/OFF Mode Set
    // oled_ins_trans(0x8B);//--8A:DC-DC is disable,8B:DC-DC will be turned on when display on.(POR)

    // oled_ins_trans(0x81);//--set contrast control register
    // oled_ins_trans(0xFF);
    
    // oled_ins_trans(0xDA);//--set com pins hardware configuration
    // oled_ins_trans(0x12);

    // oled_ins_trans(0xDB);//--set vcomh
    // oled_ins_trans(0x40);

    // oled_ins_trans(0xD9);//--set charge period
    // oled_ins_trans(0xF1);

    // oled_ins_trans(0xAF);//--turn on oled panel

}